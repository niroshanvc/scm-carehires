version: 2.1

executors:
  java-executor:
    docker:
      - image: cimg/openjdk:17.0
    working_directory: ~/repo

parameters:
  browser:
    type: string
    default: "chrome"
  feature_tag:
    type: string
    default: "@smoke"
  environment:
    type: string
    default: "dev"

jobs:
  test:
    executor: java-executor
    parameters:
      browser:
        type: string
        default: "<< parameters.browser >>"
      feature_tag:
        type: string
        default: "<< parameters.feature_tag >>"
      environment:
        type: string
        default: "<< parameters.environment >>"
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y xvfb
            sudo apt-get install -y unzip
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
            sudo apt-get update
            sudo apt-get install -y google-chrome-stable
            curl -sS -o chromedriver.zip https://chromedriver.storage.googleapis.com/2.41/chromedriver_linux64.zip
            sudo unzip chromedriver.zip -d /usr/local/bin/
            rm chromedriver.zip
            for i in {1..5}; do curl -sS -o microsoft-edge-stable.deb https://packages.microsoft.com/repos/edge/pool/main/m/microsoft-edge-stable/microsoft-edge-stable_109.0.1518.78-1_amd64.deb && break || sleep 5; done
            if [ -f microsoft-edge-stable.deb ]; then
              sudo dpkg -i microsoft-edge-stable.deb
              sudo apt-get install -f
              rm microsoft-edge-stable.deb
            else
              echo "Failed to download microsoft-edge-stable.deb"
              exit 1
            fi
            curl -sS -o edgedriver.zip https://msedgedriver.azureedge.net/109.0.1518.78/edgedriver_linux64.zip
            sudo unzip edgedriver.zip -d /usr/local/bin/
            rm edgedriver.zip
      - run:
          name: Run Tests
          command: |
            mvn clean test -Dbrowser=<< parameters.browser >> -Dcucumber.options="--tags << parameters.feature_tag >>" -Denvironment=<< parameters.environment >>

workflows:
  version: 2
  test:
    jobs:
      - test:
          browser: << pipeline.parameters.browser >>
          feature_tag: << pipeline.parameters.feature_tag >>
          environment: << pipeline.parameters.environment >>